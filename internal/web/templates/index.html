<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Priority Scheduler</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }
            .container {
                max-width: 1000px;
                margin: 0 auto;
                display: flex;
                gap: 20px;
            }
            h1 {
                color: #333;
                margin-bottom: 30px;
            }
            .card {
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .left-panel {
                flex: 2;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .right-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            h2 {
                color: #555;
                margin-bottom: 15px;
                font-size: 18px;
            }
            input,
            button {
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                cursor: pointer;
                font-weight: bold;
            }
            button:hover {
                background: #0056b3;
            }
            .btn-secondary {
                background: #6c757d;
            }
            .btn-secondary:hover {
                background: #5a6268;
            }
            .button-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .worker {
                padding: 10px;
                margin: 5px 0;
                border-radius: 4px;
                border-left: 3px solid;
            }
            .worker.busy {
                background: #fff3cd;
                border-color: #ff9800;
            }
            .worker.free {
                background: #d4edda;
                border-color: #28a745;
            }

            .job {
                padding: 8px;
                margin: 5px 0;
                background: #f8f9fa;
                border-left: 3px solid #007bff;
                border-radius: 4px;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .stat {
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }
            .stat strong {
                display: block;
                color: #666;
                font-size: 12px;
            }
            .stat span {
                font-size: 24px;
                color: #333;
            }

            /* Scrollable Job Queue */
            #queue {
                max-height: auto;
                overflow-y: auto;
                padding-right: 10px;
            }
        </style>
    </head>
    <body>
        <h1>ðŸš€ Priority Scheduler</h1>
        <div class="container">
            <div class="left-panel">
                <!-- Create Job -->
                <div class="card">
                    <h2>Create Job</h2>
                    <form id="jobForm">
                        <input
                            type="text"
                            id="name"
                            placeholder="Job name"
                            required
                        />
                        <input
                            type="number"
                            id="priority"
                            placeholder="Priority (1-100)"
                            min="1"
                            max="100"
                            value="50"
                            required
                        />
                        <input
                            type="number"
                            id="duration"
                            placeholder="Duration (seconds)"
                            min="1"
                            value="5"
                            required
                        />
                        <div class="button-group">
                            <button type="submit">Schedule Job</button>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="generateRandomJob()"
                            >
                                ðŸŽ² Random Job
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Stats -->
                <div class="card">
                    <h2>Statistics</h2>
                    <div class="stats" id="stats">
                        <div class="stat">
                            <strong>Total Workers</strong
                            ><span id="totalWorkers">-</span>
                        </div>
                        <div class="stat">
                            <strong>Busy Workers</strong
                            ><span id="busyWorkers">-</span>
                        </div>
                        <div class="stat">
                            <strong>Queued Jobs</strong
                            ><span id="queuedJobs">-</span>
                        </div>
                        <div class="stat">
                            <strong>Total Scheduled</strong
                            ><span id="totalScheduled">-</span>
                        </div>
                    </div>
                </div>

                <!-- Workers -->
                <div class="card">
                    <h2>Workers Status</h2>
                    <div id="workers"></div>
                </div>
            </div>

            <!-- Job Queue on right with scroll -->
            <div class="right-panel">
                <div class="card" style="flex: 1">
                    <h2>Job Queue</h2>
                    <div id="queue"></div>
                </div>
            </div>
        </div>

        <script>
            function randomJobName() {
                const letters =
                    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
                const length = Math.floor(Math.random() * 6) + 5;
                let name = "";
                for (let i = 0; i < length; i++) {
                    name += letters.charAt(
                        Math.floor(Math.random() * letters.length),
                    );
                }
                return name;
            }

            async function generateRandomJob() {
                const job = {
                    name: randomJobName(),
                    priority: Math.floor(Math.random() * 100) + 1,
                    duration: Math.floor(Math.random() * 10) + 1,
                };
                try {
                    const res = await fetch("/api/jobs", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(job),
                    });
                    const data = await res.json();
                    if (res.ok) {
                        console.log(
                            `âœ… Random Job #${data.id} scheduled: ${job.name}`,
                        );
                        updateAll();
                    } else {
                        alert(`âŒ Error: ${data.error}`);
                    }
                } catch (err) {
                    alert("âŒ Failed to create random job");
                }
            }

            document
                .getElementById("jobForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const job = {
                        name: document.getElementById("name").value,
                        priority: parseInt(
                            document.getElementById("priority").value,
                        ),
                        duration: parseInt(
                            document.getElementById("duration").value,
                        ),
                    };
                    try {
                        const res = await fetch("/api/jobs", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(job),
                        });
                        const data = await res.json();
                        if (res.ok) {
                            console.log(`âœ… Job #${data.id} scheduled`);
                            document.getElementById("jobForm").reset();
                            document.getElementById("priority").value = 50;
                            document.getElementById("duration").value = 5;
                            updateAll();
                        } else {
                            alert(`âŒ Error: ${data.error}`);
                        }
                    } catch (err) {
                        alert("âŒ Failed to create job");
                    }
                });

            async function updateAll() {
                await Promise.all([
                    updateStats(),
                    updateWorkers(),
                    updateQueue(),
                ]);
            }

            async function updateStats() {
                try {
                    const res = await fetch("/api/stats");
                    const stats = await res.json();
                    document.getElementById("totalWorkers").textContent =
                        stats.total_workers;
                    document.getElementById("busyWorkers").textContent =
                        stats.busy_workers;
                    document.getElementById("queuedJobs").textContent =
                        stats.queued_jobs;
                    document.getElementById("totalScheduled").textContent =
                        stats.total_scheduled;
                } catch (err) {
                    console.error(err);
                }
            }

            async function updateWorkers() {
                try {
                    const res = await fetch("/api/status");
                    const workers = await res.json();
                    document.getElementById("workers").innerHTML =
                        workers
                            .map(
                                (w) => `
                <div class="worker ${w.is_busy ? "busy" : "free"}">
                    <strong>Worker ${w.worker_id}:</strong> ${w.is_busy && w.current_job ? `Processing "${w.current_job.name}" (priority: ${w.current_job.priority})` : "Idle"}
                </div>
            `,
                            )
                            .join("") || "<p>No workers</p>";
                } catch (err) {
                    console.error(err);
                }
            }

            async function updateQueue() {
                try {
                    const res = await fetch("/api/queue");
                    const queue = await res.json();
                    if (!queue || queue.length === 0) {
                        document.getElementById("queue").innerHTML =
                            "<p>Queue is empty</p>";
                        return;
                    }
                    document.getElementById("queue").innerHTML = queue
                        .map(
                            (job) => `
                <div class="job">
                    <strong>${job.name}</strong> (Priority: ${job.priority}, Duration: ${job.duration / 1000}s)
                </div>
            `,
                        )
                        .join("");
                } catch (err) {
                    console.error(err);
                }
            }

            setInterval(updateAll, 2000);
            updateAll();
        </script>
    </body>
</html>
